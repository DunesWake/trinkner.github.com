<html class="no-js" lang="en">
<head>
	<title>Virtual Solidification</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="#">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" href="./css/main.css" rel="stylesheet">
</head>
<body>
<div id="screenClick"></div>
<div id="loading-screen"></div>
</body>
</html>

<script src=".//js/threex.windowresize.js"></script>
<script type="module">
	const loadingScreen = document.getElementById('loading-screen');
	
	import * as THREE from './js/three.module.js';
	import {GLTFLoader} from './js/GLTFLoader.js';
	import { VRButton } from './js/VRButton.js';
	
	// spash menu vars will rotate if no var given
	var rotate = "true";
	if (sessionStorage['rotate']) rotate = sessionStorage.getItem('rotate');
	var vr = "false"
	if (sessionStorage['vr']) vr = sessionStorage.getItem('vr');

	// render vars
	var files = ["./forms/small.glb", "./forms/600x900.jpg"];
	var manager = new THREE.LoadingManager();
	var loaderGLB  = new GLTFLoader(manager);
	var loaderJPG = new THREE.TextureLoader(manager);
	var cur = 0;
	var clickDir;
	var renderer;
	var container;
	var scene;
	var cam = [];
	var lights = [];
	var forms = [];
	var loaded = false;
	   
    	// starts program, calls init() when completed
	loadingScreen.classList.add('fade-in');
	loadingScreen.innerHTML = "loading.."; 
    	init();
	anim();

    // places light and camera
	// creates renderer, resize, scene
	function init() {
		container = document.createElement( 'div' );
		document.body.appendChild( container );
		
		renderer = new THREE.WebGLRenderer({});
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.setPixelRatio( window.devicePixelRatio * 1.5 );
 		renderer.xr.enabled = true;
		container.appendChild( renderer.domElement );
		
		scene = new THREE.Scene
		scene.background = new THREE.Color( 0xffffff );
		cam[0] = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		cam[0].position.z = 5.25;
		
		// default 
		lights[0] = createLight(-100, -200, 100, 0xffffff);
		
		// static image 
		lights[1] = new THREE.AmbientLight(0xffffff);
		
		// sets up camera for vr, if toggled
		const cameraHolder = new THREE.Group();
		if (vr == "true"){
			document.body.appendChild( VRButton.createButton( renderer ) );
			cameraHolder.add(cam[0]);
			cameraHolder.position.set(0, 0, 0);
			scene.add(cameraHolder);
		} else scene.add(cam[0]);
		THREEx.WindowResize(renderer, cam[0]);
	   	load(); 
	}
	
	
    // loads files into forms[]
	function load() {
		for (let i = 0; i < files.length; i++) {
			if (files[i].includes(".glb") || files[i].includes(".gltf")){
				loaderGLB.load(files[i], function(entity) {
					forms[i] = entity.scene;
					forms[i].name = files[i];
				})
			}
			if (files[i].includes(".jpg") || files[i].includes(".png")){
				var img = new THREE.MeshLambertMaterial({
					map: loaderJPG.load(files[i])
				});
				
				// retreives dimensions from file name
				var dimstr = files[i].replace("./forms/", "");
				dimstr = dimstr.replace(".jpg", "");
				dimstr = dimstr.split("x");
				var dims = [parseInt(dimstr[0]), parseInt(dimstr[1])];
				if (parseInt(dims[0]) > parseInt(dims[1]))
					var plane = new THREE.Mesh(new THREE.PlaneGeometry(3.5, 3.5*(dims[0]/dims[1])),img);
				else	var plane = new THREE.Mesh(new THREE.PlaneGeometry(  6,   6*(dims[0]/dims[1])),img);
				
				// places image in forms[]
				forms[i] = plane;
				forms[i].name = files[i];
			}
		}
		// calls when one of the onjects completes load
		manager.onProgress = function(item, loaded, total) {
			console.log((loaded - 1) + " " + (total - 1) + " " + item);
		};
		//calls when everything has been loaded
		manager.onLoad = function() {
			while(loadingScreen.firstChild) {
				loadingScreen.removeChild(loadingScreen.firstChild);
			}	
			loadingScreen.classList.remove('fade-in');
			startScreenClick();
			startKeyControls();
			formSet();
			loaded = true;
		};
	}
	
	
    // set form's initial rotational placement
	function formSet() {
		for (let i = 0; i < lights.length; i++)
        		scene.remove(lights[i])

		scene.add(forms[cur]);
		forms[cur].rotation.set(0, 0, 0);
		if (isImage()) {
			scene.add(lights[1]);
		} else if (forms[cur].name == "./forms/small.glb") {
			scene.add(lights[0]);			
			forms[cur].rotateX(6);
			forms[cur].rotateY(2);
			forms[cur].rotation.x += 3.03;
			forms[cur].rotation.y += 3.03;
		} else {
			scene.add(lights[0]);
			forms[cur].position.set(0, 0, -3);
		}
	}
	
	
    // frame call and increments rotation animation 
	function anim() {renderer.setAnimationLoop( render );}
	function render() {
		if (rotate == "true" && loaded == true && !isImage()) {
			forms[cur].rotation.x += 0.002;
			forms[cur].rotation.y += 0.002;
		}
		renderer.render( scene, cam[0]);
	}
	
	
// -- â–¼ HELPERS --------------------------------------------------------------------------------->
    
	function isImage(){
		if (forms[cur].name.includes(".jpg") || forms[cur].name.includes(".png"))
			return true;
		else	return false;   
	}
	
	function createLight(x,y,z,color, intensity) {
		var light = new THREE.PointLight(color, intensity);
		light.position.set(x, y, z);
		return light;
	}
	
	// removes from scene, remains in form[]
	function removeForm(object) {
		var selectedObject = scene.getObjectByName(object.name);
        	scene.remove(forms[cur]);
	}
	
	// screen click to change forms
	function startScreenClick() {
		var clicker = document.createElement("button");
		clicker.addEventListener("click", function(){
			if (cur == files.length - 1) clickDir = -1;
			else if (cur == 0)           clickDir = +1;
			removeForm(forms[cur])
			cur += clickDir;
			formSet();
		});
		screenClick.appendChild(clicker);
	}
	
	// arrow keys on click events
	function startKeyControls() {
		document.onkeydown = function(e) {
			var n = 0;
			if (e.keyCode == 37) if (cur != 0) n = -1;
			if (e.keyCode == 39) if (cur != files.length - 1) n = +1;
			if (n != 0) {
				removeForm(forms[cur]);
				cur += n;
				formSet();
			}
		}	
	} 
</script>