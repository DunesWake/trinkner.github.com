<html class="no-js" lang="en">
<head>
	<title>Virtual Solidification</title>
	<meta charset="utf-8">
	<link rel="shortcut icon" href="#">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" href="./css/main.css" rel="stylesheet">
</head>
<body>
<div id="ScreenClick"></div>
<div id="loading-screen"></div>
</body>
</html>

<script src=".//js/threex.windowresize.js"></script>
<script type="module">
	import * as THREE from './js/three.module.js';
	import {GLTFLoader} from './js/GLTFLoader.js';
	import {DRACOLoader}from './js/DRACOLoader.js';
	import {VRButton} from './js/VRButton.js';
	import {OrbitControls} from './js/OrbitControls.js';
	
	// file / loading vars
	var files = ["./forms/bench.glb", "./forms/rock.jpg"];
	var loaded = false;
	var cur = 0;
	var loadingScreen = document.getElementById('loading-screen');
	var manager = new THREE.LoadingManager();
	var loaderJPG = new THREE.TextureLoader(manager);
	var dracoLoader = new DRACOLoader(manager); 
	var loaderGLB = new GLTFLoader(manager); 
	dracoLoader.setDecoderPath('./js/draco/gltf/');
	dracoLoader.preload();
	loaderGLB.setDRACOLoader( dracoLoader );

	// render vars
	var rotate = "true"; if (sessionStorage['rotate']) rotate = sessionStorage.getItem('rotate');
	var vr = "false";    if (sessionStorage['vr']) vr = sessionStorage.getItem('vr');	
	var renderer;
	var container;
	var scene;
	var cam = [];
	var lights = [];
	var forms = [];
	var videos = [];
	
	
	// start
	loadingScreen.classList.add('fade-in');
	loadingScreen.innerHTML = 'loading'; 
    	init();
	function init() {
		renderer = new THREE.WebGLRenderer({ antialias: "true", precision: "highp" });
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.setPixelRatio( window.devicePixelRatio);
		document.body.appendChild(renderer.domElement);
		
		scene = new THREE.Scene
		scene.background = new THREE.Color( 0xffffff );
		cam[0] = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		cam[0].position.z = 5.25;
		scene.add(cam[0]);
		THREEx.WindowResize(renderer, cam[0]);
		if (vr === "true") initVR();
		
		//default 
		lights[0] = createLight(-100, -200, 100, 0xffffff);
		
		//static image 
		lights[1] = new THREE.AmbientLight(0xffffff);
		
		renderer.setAnimationLoop(render);
		loadThenRun();
	}
	
	
	// loads files into forms[]
	function loadThenRun() {
		let loadCnt = {};
		let loadTotal = 13227244 // I know this is dirty, email me for an explenation
		for (let i = 0, j = files.length; i < j; i++) {
			if (files[i].includes(".glb") || files[i].includes(".gltf")){
				loaderGLB.load( files[i], function (gltf) {
					forms[i] = gltf.scene;
					forms[i].name = files[i];
				 }, function (xhr) {
//					console.log(xhr.total); // use to set loadTotal
					loadCnt[files[i]] = (xhr.loaded / loadTotal * 100);
					let done = 1;
					for (let key in loadCnt) if (loadCnt[key] !== 100) done = 0;
					if (done === 1) loadingScreen.innerHTML ="uncompressing"; 
				});
			}
			if (files[i].includes(".jpg") || files[i].includes(".png")){
				let img = new Image();
				img.src = files[i];	
				img.onload = function(){
					let material = new THREE.MeshLambertMaterial({map:loaderJPG.load(files[i])});
					if (this.height > this.width)
						var plane = new THREE.PlaneGeometry(3.5, 3.5*(this.height/this.width));
					else	var plane = new THREE.PlaneGeometry(  6,   6*(this.height/this.width));
					forms[i] = new THREE.Mesh(plane,material);
					forms[i].name = files[i];
				}
			}
			if (files[i].includes(".ogv") || files[i].includes(".mp4")){	
				videos[i] = document.createElement( 'video' );
				videos[i].loop = true;
				videos[i].playsinline = true;
				videos[i].style.display = "none";
				videos[i].src = files[i];
				videos[i].load();
				videos[i].addEventListener('loadedmetadata', function(e){
					let texture = new THREE.VideoTexture( videos[i] );
					texture.minFilter = THREE.LinearFilter;
					texture.magFilter = THREE.LinearFilter;
					texture.format = THREE.RGBFormat;
					let screen = new THREE.PlaneGeometry(6, 6*(videos[i].videoHeight/videos[i].videoWidth));
					let material = new THREE.MeshLambertMaterial({map:texture});	
					
					forms[i] = new THREE.Mesh(screen,material);
					forms[i].name = files[i];
				});		
			}
		}
		// init controls/animation hear to avoid null array access
		manager.onLoad = function() {
			loadingScreen.classList.remove('fade-in');
			formSet();
			startKeyControls();
			startScreenClick();
			loaded = true;
		};
	}
	
	
	// set form's initial rotational placement
	function formSet() {	
		lights.forEach(light => scene.remove(light));
		videos.forEach(video => video.pause());
		
		if(files[cur].includes(".mp4" || ".ovg")){
			videos[cur].currentTime = 0;
			videos[cur].play();
		}  
		
		scene.add(forms[cur]);
		forms[cur].rotation.set(0, 0, 0);
		if (isImage()) {
			scene.add(lights[1]);
		} else if (forms[cur].name === "./forms/chair.glb") {
			scene.add(lights[0]);	
			forms[cur].rotation.x += 2;
		} else if (forms[cur].name === "./forms/bench.glb") {
			scene.add(lights[0]);	
			forms[cur].position.set(0, -0.2, 0);
			forms[cur].scale.set( 1.3, 1.3, 1.3);
			forms[cur].rotation.x += 0.56;
			forms[cur].rotation.y += 0.56;
		} else { scene.add(lights[0]); }
	}

	
	// frame call and animation 
	function render() {
		if (rotate === "true" && loaded === true && !isImage() && !document.hidden) {
			forms[cur].rotation.x += 0.001;
			forms[cur].rotation.y += 0.001;
//			console.log(forms[cur].rotation.x + " " + forms[cur].rotation.y);
		}
		renderer.render(scene, cam[0]);
	}
	
	
	

	
	
	
	
	
	
	
	
	
	
// -- ▼ HELPERS --------------------------------------------------------------------------------->
	
	function createLight(x,y,z, color, intensity){
		let light = new THREE.PointLight(color, intensity);
		light.position.set(x, y, z);
		return light;
	}
	function removeForm(object){
		let selectedObject = scene.getObjectByName(object.name);
        	scene.remove(forms[cur]);
	}
	function isImage(){
		return (forms[cur].name.includes(".jpg") 
			|| forms[cur].name.includes(".png")
			|| forms[cur].name.includes(".ogv")
			|| forms[cur].name.includes(".mp4")) ? true : false;
	}
	function initVR(){
 		renderer.xr.enabled = true;
		document.body.appendChild(VRButton.createButton(renderer));
	}
	function formChange(n){
		removeForm(forms[cur])
		cur += n;
		formSet();
	}
	// screen click event listener
	function startScreenClick(){
		let n = 0;
		let click = document.createElement("button");
		click.addEventListener("click", function(){
			if (cur === files.length - 1) n = -1;
			else if (cur === 0) n = 1;
			formChange(n);
		});
		ScreenClick.appendChild(click);
	}
	// WASD and arrow keys  on click events
	function startKeyControls(){
		document.onkeydown = function(e) {
			let n = 0;
			if (e.keyCode === 37) if (cur !== 0               ) n = -1;
			if (e.keyCode === 39) if (cur !== files.length - 1) n = +1;
			if (n !== 0) formChange(n);
		}	
	} 
</script>

<!--
written by clement trinkner
cbtrinkner@gmail.com
꒱࿐♡ ˚.*ೃ
-->
