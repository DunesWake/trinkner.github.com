<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<title>Virtual Solidification</title>
	<link rel="shortcut icon" href="#">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0">
	<link href=".//css/main.css" rel="stylesheet">
</head>
    
<div id="screenClick"></div>
<div id="splash-screen"></div>
<div id="loading-screen"></div>
</html>

<script src=".//js/threex.windowresize.js"></script>
<script type="module">
	const splashScreen  = document.getElementById('splash-screen' );
	const loadingScreen = document.getElementById('loading-screen');

	import { VRButton } from './js/VRButton.js';
	import * as THREE from './js/three.module.js';
	import {GLTFLoader} from './js/GLTFLoader.js';
	var manager = new THREE.LoadingManager();
	var loader  = new GLTFLoader(manager);
	
	// spash menu vars
	var menuBtn = [];
	var rotate = true;
	var audio = true;
	var english = ["about	", "yes", "rotation "];
	var german =  ["Über", "aus", "drehung "];
	var french =  ["sur", "1", "tourner "];
	var chinese = ["关于", "联络人", "旋转 "];
	var langs = [english,german,french,chinese];
	var curLang = 3;

	// render vars
	var files = ["./forms/small.glb", "./forms/2.glb"];
	var clickDir;
	var renderer;
	var scene;
	var cur = 0;
	var cam = [];
	var lights = [];
	var forms = [];
	
    
// -- ▼ MAIN ------------------------------------------------------------------------------------>
   
    	// starts program, calls init() when completed
	splashMenu();
    
    	// places light and camera
	// creates renderer, resize, scene
	function init() {
		splashScreen.remove(); 
	    	loadingScreen.classList.add('fade-in');
	    
		renderer = new THREE.WebGLRenderer({alpha: true});
		renderer.setSize(window.innerWidth, window.innerHeight);
	    	renderer.setPixelRatio( window.devicePixelRatio * 3 );
		renderer.xr.enabled = true;

		document.body.appendChild(renderer.domElement);
		scene = new THREE.Scene
		cam[0] = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		cam[0].position.z = 5.25;
		THREEx.WindowResize(renderer, cam[0])
	    
		lights[0] = createLight(-100, -200, 100, 0xFFFFFF);
	    	load(); 
	    	//anim() calls in load().onLoad()
	}
    	// loads requested files into forms[]
	function load() {
		for (let i = 0; i < files.length; i++) {
			loader.load(files[i], function(entity) {
				forms[i] = entity.scene;
				forms[i].name = files[i];
			})
		}
		manager.onProgress = function(item, loaded, total) {
			loadingScreen.innerHTML = (loaded - 1) + "/" + (total - 1);
			console.log((loaded - 1) + " " + (total - 1) + " " + item);
		};
		manager.onLoad = function() {
			loadingScreen.classList.remove('fade-in');
			startScreenClick();
			startKeyControls();
			formSet();
			anim();
		};
	}
    	// set form's initial rotational placement
	function formSet() {
		for (let i = 0; i < lights.length; i++) 
        		scene.remove(lights[i])

	    	scene.add(forms[cur]);
		forms[cur].rotation.set(0, 0, 0);
		forms[cur].rotateX(6);
		forms[cur].rotateY(2);
		if (forms[cur].name == "./forms/small.glb") {
			scene.add(lights[0]);
			forms[cur].rotation.x += 3.03;
			forms[cur].rotation.y += 3.03;
		} else {
			scene.add(lights[0]);
			forms[cur].rotation.x += 2;
		}
	}
    	// frame call and increments rotation animation 
	function anim() {
		renderer.setAnimationLoop( function () {
			if (rotate) {
				forms[cur].rotation.x += 0.002;
				forms[cur].rotation.y += 0.002;
			}
			renderer.render( scene, cam[0] );
		} );
//		let animate = function() {
//			requestAnimationFrame(animate);
//			if (rotate) {
//				forms[cur].rotation.x += 0.002;
//				forms[cur].rotation.y += 0.002;
//			}
//			renderer.render(scene, cam[0]);
//		};
//		animate();
	}
	
    
// -- ▼ HELPERS --------------------------------------------------------------------------------->
    
	function createLight(x,y,z,color, intensity) {
		var light = new THREE.PointLight(color, intensity);
		light.position.set(x, y, z);
		return light;
	}
	// removes from scene, remains in form[]
	function removeForm(object) {
		var selectedObject = scene.getObjectByName(object.name);
        	scene.remove(forms[cur]);
	}
	// screen click event listener
	function startScreenClick() {
		var clicker = document.createElement("button");
		clicker.addEventListener("click", function(){
			if (cur == files.length - 1) clickDir = -1;
			else if (cur == 0)           clickDir = +1;
			removeForm(forms[cur])
			cur += clickDir;
			formSet();
		});
		screenClick.appendChild(clicker);
	}
	// WASD and arrow keys  on click events
	function startKeyControls() {
		document.onkeydown = function(e) {
			var n = 0;
			if (e.keyCode == 37) if (cur != 0) n = -1;
			if (e.keyCode == 39) if (cur != files.length - 1) n = +1;
			if (n != 0) {
				removeForm(forms[cur]);
				cur += n;
				formSet();
			}
		}	
	}

    
// -- ▼ SPLASH MENU --------------------------------------------------------------------------------->
    
	// rebuilds from scratch, each time a variable is changed
	function splashMenu() {
		while(splashScreen.firstChild) {
			splashScreen.removeChild(splashScreen.firstChild);
		}	
		// LANGUAGE
		menuBtn[0] = insertMenuBtn("english", curLang == 0);
		menuBtn[0].onclick = () => {curLang = 0; splashMenu();}
		insertMenuSlash();
		menuBtn[1] = insertMenuBtn("deutsche", curLang == 1);
		menuBtn[1].onclick = () => {curLang = 1; splashMenu();}
		insertMenuSlash();
		menuBtn[2] = insertMenuBtn("française", curLang == 2);
		menuBtn[2].onclick = () => {curLang = 2; splashMenu();}
		insertMenuSlash();
		menuBtn[3] = insertMenuBtn("中文", curLang == 3);
		menuBtn[3].onclick = () => {curLang = 3; splashMenu();}
		insertMenuSlash();
		insertMenuNewLine();
		
		splashScreen.appendChild( VRButton.createButton( renderer ) );
		insertMenuNewLine();


		// ROTATION
	    	insertMenuBtn(langs[curLang][2], 1);
		insertMenuSlash(); 
		menuBtn[10] = insertMenuBtn("0", !rotate);
		menuBtn[10].onclick = () => {rotate = 0; splashMenu();}
		insertMenuSlash();
		menuBtn[11] = insertMenuBtn("1", rotate);
		menuBtn[11].onclick = () => {rotate = 1; splashMenu();}
		insertMenuSlash();

		// EXIT 
		menuBtn[9] = insertMenuBtn(">", true);
		menuBtn[9].onclick = () => init();
		
		// ABOUT, CONTACTS
		insertMenuNewLine();
		insertMenuNewLine();
		insertMenuNewLine();
		menuBtn[12] = insertMenuBtn(langs[curLang][0], 0);
		menuBtn[12].onclick = () => {}
	}
	function insertMenuBtn(text, active) {
		var btn = document.createElement("BUTTON"); 
	    	btn.innerHTML = text;  		
		if (active) 
		    btn.style.color = "#111";
		else btn.style.color = "#BBB";
		splashScreen.appendChild(btn);
		return btn;
	}
	function insertMenuSlash() {
		var sep = document.createElement("a");   
		sep.innerHTML = "/";                  
		splashScreen.appendChild(sep);
	}
	function insertMenuNewLine() {
		var nl = document.createElement("br");  
		splashScreen.appendChild(nl);
	}
</script>